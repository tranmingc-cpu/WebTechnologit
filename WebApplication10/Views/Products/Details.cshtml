@model WebApplication10.Models.Products

@{
    Layout = null;
    ViewBag.Title = Model.ProductName;
    var finalPrice = Model.Price - (Model.Discount ?? 0);
    var discountPercent = Model.Discount.HasValue && Model.Price > 0 ? (int)((Model.Discount.Value / Model.Price) * 100) : 0;
    var isInStock = Model.Quantity.HasValue && Model.Quantity.Value > 0;
}

<div class="product-details-container">
    <div class="breadcrumb">
        <a href="@Url.Action("Index", "Home")">Trang chủ</a>
        <span>/</span>
        <a href="@Url.Action("Index", "Products")">Sản phẩm</a>
        <span>/</span>
        <span>@Model.ProductName</span>
    </div>

    <div class="product-details-main">
        <div class="product-images-section">
            <div class="main-image">
                <img id="mainProductImage" src="@(string.IsNullOrEmpty(Model.ImageUrl) ? "/Content/images/no-image.png" : "/Content/images/" + Model.ImageUrl)" 
                     alt="@Model.ProductName" />
            </div>
        </div>

        <div class="product-info-section">
            <h1 class="product-title">@Model.ProductName</h1>

            <div class="product-meta">
                <div class="meta-item">
                    <span class="meta-label">Thương hiệu:</span>
                    <span class="meta-value brand-name">@(Model.Brands?.BrandName ?? "N/A")</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Tình trạng:</span>
                    <span class="meta-value stock-status @(isInStock ? "in-stock" : "out-of-stock")">
                        @(isInStock ? "Còn hàng" : "Hết hàng")
                    </span>
                </div>
            </div>

            <div class="product-price-section">
                @if (Model.Discount.HasValue && Model.Discount > 0)
                {
                    <div class="price-row">
                        <span class="original-price">@String.Format("{0:N0}đ", Model.Price)</span>
                        @if (discountPercent > 0)
                        {
                            <span class="discount-badge">-@discountPercent%</span>
                        }
                    </div>
                }
                <div class="current-price">@String.Format("{0:N0}đ", finalPrice)</div>
            </div>

            <div class="product-actions-form">
                <input type="hidden" id="productId" value="@Model.ProductId" />
                
                <div class="quantity-selector">
                    <label>Số lượng:</label>
                    <div class="quantity-controls">
                        <button type="button" class="qty-btn" id="decreaseQty">-</button>
                        <input type="number" id="quantityInput" value="1" min="1" max="@(Model.Quantity ?? 1)" />
                        <button type="button" class="qty-btn" id="increaseQty">+</button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn-add-cart" id="btnAddToCart" @(!isInStock ? "disabled" : "") data-product-id="@Model.ProductId">
                        <i class="fa fa-shopping-cart"></i>
                        Thêm vào giỏ hàng
                    </button>
                    <button type="button" class="btn-buy-now" @(!isInStock ? "disabled" : "") onclick="buyNow(@Model.ProductId)">
                        Mua ngay
                    </button>
                </div>
            </div>

            <div class="product-policies">
                <div class="policy-item">
                    <i class="fa fa-shield-alt"></i>
                    <span>Hoàn tiền 100% nếu hàng giả</span>
                </div>
                <div class="policy-item">
                    <i class="fa fa-clock"></i>
                    <span>Hỗ trợ 24/7</span>
                </div>
                <div class="policy-item">
                    <i class="fa fa-certificate"></i>
                    <span>Đổi trả trong 7 ngày</span>
                </div>
                <div class="policy-item">
                    <i class="fa fa-check-circle"></i>
                    <span>Bảo hành chính háng</span>
                </div>
            </div>
        </div>
    </div>

    <div class="product-description-section">
        <h2 class="section-title">Thông số kĩ thuật</h2>
        <div class="description-content">
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                @Html.Raw(Model.Description.Replace("\n", "<br />"))
            }
            else
            {
                <p class="no-description">Chưa có mô tá chi tiết cho sản phẩm này.</p>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var maxQty = @(Model.Quantity ?? 1);
            
            $('#increaseQty').click(function () {
                var input = $('#quantityInput');
                var currentVal = parseInt(input.val()) || 1;
                if (currentVal < maxQty) {
                    input.val(currentVal + 1);
                }
            });

            $('#decreaseQty').click(function () {
                var input = $('#quantityInput');
                var currentVal = parseInt(input.val()) || 1;
                if (currentVal > 1) {
                    input.val(currentVal - 1);
                }
            });

            $('#quantityInput').on('input', function () {
                var val = parseInt($(this).val()) || 1;
                if (val < 1) $(this).val(1);
                if (val > maxQty) $(this).val(maxQty);
            });

            // Add to cart with AJAX
            $('#btnAddToCart').on('click', function () {
                var btn = $(this);
                var productId = btn.data('product-id');
                var quantity = parseInt($('#quantityInput').val()) || 1;
                
                if (btn.prop('disabled')) {
                    return;
                }
                
                var originalText = btn.html();
                btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Đang thêm...');
                
                $.ajax({
                    url: '@Url.Action("AddToCart", "Cart")',
                    type: 'POST',
                    data: { productId: productId, quantity: quantity },
                    success: function (response) {
                        if (response.success) {
                            btn.html('<i class="fa fa-check"></i> Đã thêm');
                            
                            // Update cart badge
                            var badge = $('.cart-badge');
                            if (badge.length) {
                                badge.text(response.cartCount).show();
                            } else {
                                $('.cart-link').append('<span class="cart-badge">' + response.cartCount + '</span>');
                            }
                            
                            // Show notification
                            showNotification(response.message, 'success');
                            
                            setTimeout(function () {
                                btn.prop('disabled', false).html(originalText);
                            }, 2000);
                        } else {
                            btn.prop('disabled', false).html(originalText);
                            showNotification(response.message, 'error');
                        }
                    },
                    error: function () {
                        btn.prop('disabled', false).html(originalText);
                        showNotification('Có lỗi xảy ra, vui lòng thử lại', 'error');
                    }
                });
            });
            
            function showNotification(message, type) {
                var bgColor = type === 'success' ? '#4caf50' : '#f44336';
                var notification = $('<div class="cart-notification">' + message + '</div>');
                notification.css({
                    'position': 'fixed',
                    'top': '20px',
                    'right': '20px',
                    'background': bgColor,
                    'color': 'white',
                    'padding': '15px 25px',
                    'border-radius': '4px',
                    'box-shadow': '0 2px 8px rgba(0,0,0,0.2)',
                    'z-index': '10000',
                    'animation': 'slideIn 0.3s ease-out'
                });
                
                $('body').append(notification);
                
                setTimeout(function () {
                    notification.fadeOut(300, function () {
                        $(this).remove();
                    });
                }, 3000);
            }
        });

        function buyNow(productId) {
            var quantity = $('#quantityInput').val();
            window.location.href = '@Url.Action("Checkout", "Order")' + '?productId=' + productId + '&quantity=' + quantity;
        }
    </script>
}
